services:
  dragonfly:
    image: 'docker.dragonflydb.io/dragonflydb/dragonfly'
    hostname: dragonfly
    container_name: samvit-dragonfly
    ulimits:
      memlock: -1
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - dragonflydata:/data
    networks:
      - samvit

  postgres:
    image: postgres:18.1
    hostname: postgres
    container_name: samvit-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-samvituser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-samvitpassword}
      POSTGRES_DB: ${POSTGRES_DB:-samvitdb}
    ports:
      - "${POSTGRES_PORT:-5433}:5432"
    volumes:
      - pgdata:/var/lib/postgresql
    networks:
      - samvit
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-samvituser} -d ${POSTGRES_DB:-samvitdb}"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    hostname: backend
    container_name: samvit-backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=${DATABASE_URL:-postgresql+asyncpg://samvituser:samvitpassword@postgres:5432/samvitdb}
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production-min-32-chars}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DEBUG=${DEBUG:-false}
      - REDIS_URL=${REDIS_URL:-redis://dragonfly:6379/0}
    networks:
      - samvit
    depends_on:
      dragonfly:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    hostname: frontend
    container_name: samvit-frontend
    ports:
      - "3010:80"
    networks:
      - samvit
    depends_on:
      - backend
    environment:
      - VITE_API_URL=${VITE_API_URL:-http://localhost:8000}

  # Init container to seed sample tenants
  init-tenants:
    image: curlimages/curl:latest
    container_name: samvit-init-tenants
    volumes:
      - ./scripts/init-tenants.sh:/init-tenants.sh:ro
    entrypoint: ["/bin/sh", "/init-tenants.sh"]
    networks:
      - samvit
    depends_on:
      backend:
        condition: service_healthy
    restart: "no"

volumes:
  dragonflydata:
  pgdata:

networks:
  samvit:
    driver: bridge